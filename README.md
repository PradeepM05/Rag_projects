-- First, get parent data for day 1
WITH PARENT_DAY1 AS (
    SELECT 
        T1.EOD_MKT_INSM_DIM_KY,
        T1.INSM_PME_ID,
        T1.INSM_ISSR_BB_CO_ID,
        T1.INSM_ISSR_BB_CO_NM,
        T2.ID_BB_PARENT_CO AS PARENT_CO_ID,
        T2.LONG_PARENT_COMP_NAME AS PARENT_CO_NM,
        PARENT_Z.* -- All parent columns for day 1
    FROM CDM_ACTIMIZE.EQUITY_PRICING_SCR_HIST T1
    JOIN CDN_STG.CREDITRISKV2_STG T2
        ON T1.INSM_ISSR_BB_CO_ID = T2.ID_BB_COMPANY
    JOIN CDM_ACTIMIZE.EQUITY_PRICING_SCR_HIST PARENT_Z
        ON T2.ID_BB_PARENT_CO = PARENT_Z.INSM_ISSR_BB_CO_ID
        AND PARENT_Z.COB_DT = T1.COB_DT
    WHERE T1.COB_DT = '24-Apr-2025'
    AND T1.INSM_ISSR_BB_CO_ID = 8286507
),
-- Get parent data for day 2 
PARENT_DAY2 AS (
    SELECT 
        PARENT_Z2.* -- All parent columns for day 2
    FROM CDM_ACTIMIZE.EQUITY_PRICING_SCR_HIST T1_NEXT
    JOIN CDN_STG.CREDITRISKV2_STG T2
        ON T1_NEXT.INSM_ISSR_BB_CO_ID = T2.ID_BB_COMPANY
    JOIN CDM_ACTIMIZE.EQUITY_PRICING_SCR_HIST PARENT_Z2
        ON T2.ID_BB_PARENT_CO = PARENT_Z2.INSM_ISSR_BB_CO_ID
        AND PARENT_Z2.COB_DT = T1_NEXT.COB_DT
    WHERE T1_NEXT.COB_DT = '25-Apr-2025' -- Next day
    AND T1_NEXT.INSM_ISSR_BB_CO_ID = 8286507
)
-- Join day 1 and day 2 data using a unique identifier for the parent company
SELECT 
    D1.*,
    D2.COLUMN1 AS NEXT_DAY_COLUMN1,
    D2.COLUMN2 AS NEXT_DAY_COLUMN2
    -- Add other day 2 columns as needed
FROM PARENT_DAY1 D1
LEFT JOIN PARENT_DAY2 D2
    ON D1.PARENT_CO_ID = D2.INSM_ISSR_BB_CO_ID
    -- Add additional matching criteria if needed
    -- For example, if there's a unique identifier for each parent company record:
    AND D1.SOME_PARENT_UNIQUE_ID = D2.SOME_PARENT_UNIQUE_ID;
