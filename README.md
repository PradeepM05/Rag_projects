-- First, add the new columns if they don't exist
ALTER TABLE CDM_ACTIMIZE.EQ_PRICING_CREDIT_RISK_CORR 
ADD (
    PX_CHG_CORR NUMBER,
    PX_CHG_CORR_COUNT NUMBER
);

-- Single query to update both columns
MERGE INTO CDM_ACTIMIZE.EQ_PRICING_CREDIT_RISK_CORR t1
USING (
    SELECT 
        CHILD_CO_ID,
        PARENT_CO_ID,
        CORR(PXCHG_SCR, PARENT_D0_PXCHG_SCR) AS correlation,
        COUNT(*) AS data_count
    FROM CDM_ACTIMIZE.EQ_PRICING_CREDIT_RISK_CORR
    WHERE PXCHG_SCR IS NOT NULL
    AND PARENT_D0_PXCHG_SCR IS NOT NULL
    GROUP BY CHILD_CO_ID, PARENT_CO_ID
) t2
ON (t1.CHILD_CO_ID = t2.CHILD_CO_ID AND t1.PARENT_CO_ID = t2.PARENT_CO_ID)
WHEN MATCHED THEN UPDATE SET
    t1.PX_CHG_CORR = t2.correlation,
    t1.PX_CHG_CORR_COUNT = t2.data_count;
